<!doctype html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏• (Pro)</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; }
    .tab-active { background: rgba(255,255,255,0.2); border-left: 4px solid white; font-weight: bold; }
    .status-available { background: #dcfce7; color: #166534; }
    .status-borrowed { background: #fef3c7; color: #92400e; }
    .status-overdue { background: #fecaca; color: #991b1b; }
    .sidebar-gradient { background: linear-gradient(180deg, #1e3a8a 0%, #2563eb 100%); }
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 16px 24px; border-radius: 12px; color: white; z-index: 1000; transition: all 0.3s ease; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
  </style>
</head>
<body class="h-full bg-slate-50">
  <div id="app" class="h-full flex overflow-hidden">
    
    <aside class="sidebar-gradient w-64 flex-shrink-0 flex flex-col text-white shadow-xl">
      <div class="p-6 border-b border-white/10 text-center">
        <div class="text-4xl mb-2">üì¶</div>
        <h1 class="text-lg font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h1>
        <p class="text-xs text-blue-100 opacity-80">Connected to Supabase</p>
      </div>
      <nav class="flex-1 p-4 space-y-2 mt-4">
        <button onclick="switchTab('dashboard')" id="tab-dashboard" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-white/10 transition tab-active"> üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î </button>
        <button onclick="switchTab('transactions')" id="tab-transactions" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-white/10 transition"> üìã ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô </button>
        <div class="pt-4 pb-2 px-4 text-xs font-bold uppercase text-blue-200 opacity-60">Admin Section</div>
        <button onclick="switchTab('equipment')" id="tab-equipment" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-white/10 transition"> üîß ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå </button>
        <button onclick="switchTab('users')" id="tab-users" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-white/10 transition"> üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ </button>
        <button onclick="switchTab('reports')" id="tab-reports" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-white/10 transition"> üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ </button>
      </nav>
    </aside>

    <main class="flex-1 overflow-auto bg-gray-50">
      
      <div id="content-dashboard" class="p-8 space-y-8">
        <header>
            <h2 class="text-3xl font-bold text-gray-800">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö üëã</h2>
        </header>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <p class="text-sm text-gray-400">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</p>
            <p id="stat-total" class="text-3xl font-bold text-blue-600">-</p>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <p class="text-sm text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°‡∏≠‡∏≠‡∏Å</p>
            <p id="stat-borrowed" class="text-3xl font-bold text-orange-500">-</p>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <p class="text-sm text-gray-400">‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô (Overdue)</p>
            <p id="stat-overdue" class="text-3xl font-bold text-red-500">-</p>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6 border-b border-gray-50 font-bold text-gray-700 flex justify-between">
                <span>‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô</span>
                <span class="text-xs text-gray-400">‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 text-left">
                        <tr>
                            <th class="p-4">‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</th>
                            <th class="p-4">‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                            <th class="p-4 text-center">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô</th>
                        </tr>
                    </thead>
                    <tbody id="overdue-list" class="divide-y divide-gray-100">
                        </tbody>
                </table>
            </div>
        </div>
      </div>

      <div id="content-transactions" class="p-8 hidden">
        <h2 class="text-2xl font-bold mb-6">üìã ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                <h3 class="font-bold mb-4 flex items-center gap-2 text-blue-700">‚ûï ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</h3>
                <form id="borrowForm" class="space-y-4">
                    <div>
                        <label class="text-xs font-semibold text-gray-500 ml-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</label>
                        <select id="borrowUser" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none mt-1"></select>
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-gray-500 ml-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á)</label>
                        <select id="borrowEquip" required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none mt-1"></select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-semibold text-gray-500 ml-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏¢‡∏∑‡∏°</label>
                            <input type="date" id="borrowDate" required class="w-full p-2 border border-gray-200 rounded-lg text-sm mt-1">
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-500 ml-1">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô</label>
                            <input type="date" id="dueDate" required class="w-full p-2 border border-gray-200 rounded-lg text-sm mt-1">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700 transition font-bold shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</button>
                </form>
            </div>
            <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 text-gray-600">
                        <tr>
                            <th class="p-4 text-left">‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</th>
                            <th class="p-4 text-left">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                            <th class="p-4 text-center">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô</th>
                            <th class="p-4 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="p-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="transactionList" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
      </div>

      <div id="content-equipment" class="p-8 hidden">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">üîß ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm h-fit">
                <h3 class="font-bold mb-4 text-green-700">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà</h3>
                <form id="equipmentForm" class="space-y-4">
                    <input type="text" id="equipCode" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (‡πÄ‡∏ä‡πà‡∏ô CAM-01)" required class="w-full p-3 border border-gray-200 rounded-xl">
                    <input type="text" id="equipName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" required class="w-full p-3 border border-gray-200 rounded-xl">
                    <input type="number" id="equipQty" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á" min="0" required class="w-full p-3 border border-gray-200 rounded-xl">
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏Ñ‡∏•‡∏±‡∏á</button>
                </form>
            </div>
            <div class="lg:col-span-2 bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="p-4 text-left">‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                            <th class="p-4 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                            <th class="p-4 text-center">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
                            <th class="p-4 text-center">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</th>
                            <th class="p-4 text-center">‡∏•‡∏ö</th>
                        </tr>
                    </thead>
                    <tbody id="equipmentList" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
      </div>

      <div id="content-users" class="p-8 hidden">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm h-fit">
                <form id="userForm" class="space-y-4">
                    <input type="text" id="userId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" required class="w-full p-3 border border-gray-200 rounded-xl font-mono">
                    <input type="text" id="userName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required class="w-full p-3 border border-gray-200 rounded-xl">
                    <input type="text" id="userDept" placeholder="‡πÅ‡∏ú‡∏ô‡∏Å/‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î" required class="w-full p-3 border border-gray-200 rounded-xl">
                    <input type="tel" id="userPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" required class="w-full p-3 border border-gray-200 rounded-xl">
                    <select id="userRole" class="w-full p-3 border border-gray-200 rounded-xl bg-white font-semibold">
                        <option value="user">User (‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</option>
                        <option value="admin">Admin (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö)</option>
                    </select>
                    <button type="submit" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                </form>
            </div>
            <div class="lg:col-span-3 bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="p-4 text-left">ID</th>
                            <th class="p-4 text-left">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                            <th class="p-4 text-left">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</th>
                            <th class="p-4 text-center">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th>
                            <th class="p-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="userList" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
      </div>

      <div id="content-reports" class="p-8 hidden">
          <h2 class="text-2xl font-bold mb-6">üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏•‡∏±‡∏á</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm">
                  <h3 class="font-bold mb-4 text-blue-800 flex items-center gap-2">
                    <span>üèÜ 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</span>
                  </h3>
                  <div id="report-popular" class="space-y-3">
                      </div>
              </div>
          </div>
      </div>
    </main>
  </div>

  <script>
    // --- 1) CONFIGURATION ---
    const SUPABASE_URL = 'https://emfthjerfcvfmwancjbx.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_d1bqb5SJuK1pc-JgiaMD6Q_EZBWJCgt'; // ‡πÉ‡∏ä‡πâ Key ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤
    
    // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ _supabase ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏ô‡∏Å‡∏±‡∏ö global object ‡∏Ç‡∏≠‡∏á library
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let state = {
        equipment: [],
        users: [],
        transactions: [],
        summary: {}
    };

    // --- 2) UI NAVIGATION (‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡∏ô‡∏≠‡∏Å initApp ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ HTML ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ) ---
    function switchTab(tabId) {
        // ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const contents = ['dashboard', 'transactions', 'equipment', 'users', 'reports'];
        contents.forEach(id => {
            const el = document.getElementById(`content-${id}`);
            if (el) el.classList.add('hidden');
            const tab = document.getElementById(`tab-${id}`);
            if (tab) tab.classList.remove('tab-active');
        });

        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        document.getElementById(`content-${tabId}`).classList.remove('hidden');
        document.getElementById(`tab-${tabId}`).classList.add('tab-active');
    }

    // --- 3) DATA ACTIONS ---
    async function initApp() {
        console.log("Initializing App...");
        try {
            await Promise.all([
                fetchEquipment(),
                fetchUsers(),
                fetchTransactions(),
                fetchSummary()
            ]);
            updateDropdowns();
            renderAll();
            setDefaultDates();
        } catch (err) {
            console.error("Critical Error during init:", err);
        }
    }

    async function fetchEquipment() {
        const { data, error } = await _supabase.rpc('get_equipment_availability');
        if (!error) state.equipment = data;
    }

    async function fetchUsers() {
        const { data, error } = await _supabase.from('users').select('*').order('created_at', { ascending: false });
        if (!error) state.users = data;
    }

    async function fetchTransactions() {
        const { data, error } = await _supabase.from('transactions')
            .select('*')
            .order('created_at', { ascending: false });
        if (!error) state.transactions = data;
    }

    async function fetchSummary() {
        const { data, error } = await _supabase.from('dashboard_summary').select('*').single();
        if (!error) {
            state.summary = data;
            document.getElementById('stat-total').textContent = data.total_equipment;
            document.getElementById('stat-borrowed').textContent = data.total_borrowed;
            document.getElementById('stat-overdue').textContent = data.total_overdue;
        }
    }

    // --- 4) RENDERING LOGIC ---
    function renderAll() {
        // Equipment List
        document.getElementById('equipmentList').innerHTML = state.equipment.map(e => `
            <tr>
                <td class="p-4 font-mono font-bold text-slate-700">${e.equipment_code}</td>
                <td class="p-4">${e.equipment_name}</td>
                <td class="p-4 text-center">${e.total_quantity}</td>
                <td class="p-4 text-center font-bold ${e.available_quantity > 0 ? 'text-green-600' : 'text-red-500'}">${e.available_quantity}</td>
                <td class="p-4 text-center"><button onclick="deleteItem('equipment', '${e.equipment_code}')" class="text-red-300 hover:text-red-600 transition">üóëÔ∏è</button></td>
            </tr>
        `).join('');

        // Transaction List
        const today = new Date();
        document.getElementById('transactionList').innerHTML = state.transactions.map(t => {
            const isOverdue = new Date(t.transaction_due_date) < today && t.transaction_status === 'borrowed';
            return `
                <tr>
                    <td class="p-4 font-semibold">${t.transaction_user_id}</td>
                    <td class="p-4 font-mono text-xs">${t.transaction_equipment_code}</td>
                    <td class="p-4 text-center">${t.transaction_due_date}</td>
                    <td class="p-4 text-center">
                        <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase shadow-sm ${t.transaction_status === 'returned' ? 'status-available' : (isOverdue ? 'status-overdue' : 'status-borrowed')}">
                            ${t.transaction_status === 'returned' ? '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : (isOverdue ? '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°')}
                        </span>
                    </td>
                    <td class="p-4 text-center">
                        ${t.transaction_status === 'borrowed' ? `<button onclick="returnItem('${t.id}')" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-blue-700 shadow-sm transition">‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á</button>` : '-'}
                    </td>
                </tr>
            `;
        }).join('');

        // User List
        document.getElementById('userList').innerHTML = state.users.map(u => `
            <tr>
                <td class="p-4 font-bold text-blue-900 font-mono text-xs">${u.user_id}</td>
                <td class="p-4 leading-tight">
                    <span class="font-semibold text-gray-800">${u.user_name}</span><br>
                    <span class="text-xs text-gray-400">${u.user_department}</span>
                </td>
                <td class="p-4 font-mono text-xs text-gray-500">${u.user_phone || '-'}</td>
                <td class="p-4 text-center">
                    <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded border border-slate-200 uppercase font-bold text-slate-500">${u.user_role}</span>
                </td>
                <td class="p-4 text-center">
                    <button onclick="deleteItem('users', '${u.user_id}')" class="text-red-300 hover:text-red-600 transition">üóëÔ∏è</button>
                </td>
            </tr>
        `).join('');

        // Overdue Dashboard list
        const overdueItems = state.transactions.filter(t => t.transaction_status === 'borrowed' && new Date(t.transaction_due_date) < today);
        document.getElementById('overdue-list').innerHTML = overdueItems.length > 0 ? overdueItems.map(t => `
            <tr>
                <td class="p-4 font-bold text-red-700">${t.transaction_user_id}</td>
                <td class="p-4 font-mono text-gray-500">${t.transaction_equipment_code}</td>
                <td class="p-4 text-center font-semibold text-red-500">${t.transaction_due_date}</td>
            </tr>
        `).join('') : '<tr><td colspan="3" class="p-8 text-center text-gray-300">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</td></tr>';

        renderPopular();
    }

    async function renderPopular() {
        const { data } = await _supabase.from('popular_equipment').select('*').limit(5);
        if (data && data.length > 0) {
            document.getElementById('report-popular').innerHTML = data.map((item, idx) => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl border border-gray-100">
                    <div class="flex items-center gap-3">
                        <span class="w-6 h-6 bg-blue-100 text-blue-700 flex items-center justify-center rounded-full text-xs font-bold">${idx+1}</span>
                        <span class="font-mono font-bold text-slate-700">${item.transaction_equipment_code}</span>
                    </div>
                    <span class="font-bold text-blue-600 bg-white px-3 py-1 rounded-lg border shadow-sm">${item.borrow_count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                </div>
            `).join('');
        } else {
            document.getElementById('report-popular').innerHTML = '<p class="text-gray-400 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</p>';
        }
    }

    // --- 5) FORM SUBMISSIONS ---
    document.getElementById('borrowForm').onsubmit = async (e) => {
        e.preventDefault();
        const payload = {
            transaction_user_id: document.getElementById('borrowUser').value,
            transaction_equipment_code: document.getElementById('borrowEquip').value,
            transaction_borrow_date: document.getElementById('borrowDate').value,
            transaction_due_date: document.getElementById('dueDate').value,
            transaction_status: 'borrowed'
        };
        
        const { error } = await _supabase.from('transactions').insert([payload]);
        if (error) {
            alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏∑‡∏°‡πÑ‡∏î‡πâ: " + error.message);
        } else {
            showToast("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
            e.target.reset();
            initApp();
        }
    };

    document.getElementById('equipmentForm').onsubmit = async (e) => {
        e.preventDefault();
        const payload = {
            equipment_code: document.getElementById('equipCode').value,
            equipment_name: document.getElementById('equipName').value,
            equipment_quantity: parseInt(document.getElementById('equipQty').value)
        };
        const { error } = await _supabase.from('equipment').insert([payload]);
        if (error) alert("‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
        else { showToast("üì¶ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏•‡∏á‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß"); e.target.reset(); initApp(); }
    };

    document.getElementById('userForm').onsubmit = async (e) => {
        e.preventDefault();
        const payload = {
            user_id: document.getElementById('userId').value,
            user_name: document.getElementById('userName').value,
            user_department: document.getElementById('userDept').value,
            user_phone: document.getElementById('userPhone').value,
            user_role: document.getElementById('userRole').value
        };
        const { error } = await _supabase.from('users').insert([payload]);
        if (error) alert("‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message);
        else { showToast("üë• ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); e.target.reset(); initApp(); }
    };

    // --- 6) EXTERNAL FUNCTIONS (Must be Global) ---
    async function returnItem(id) {
        if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå?")) return;
        const { error } = await _supabase.from('transactions')
            .update({ 
                transaction_status: 'returned', 
                transaction_return_date: new Date().toISOString() 
            })
            .eq('id', id);
        
        if (!error) { 
            showToast("üîÑ ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "bg-blue-600"); 
            initApp(); 
        } else {
            alert("Error returning: " + error.message);
        }
    }

    async function deleteItem(table, code) {
        if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÑ‡∏°‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà)?')) return;
        const column = table === 'users' ? 'user_id' : 'equipment_code';
        const { error } = await _supabase.from(table).delete().eq(column, code);
        
        if (error) alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡πÑ‡∏î‡πâ: " + error.message);
        else { 
            showToast("üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "bg-gray-800"); 
            initApp(); 
        }
    }

    // --- 7) HELPERS ---
    function updateDropdowns() {
        document.getElementById('borrowUser').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏° --</option>' + 
            state.users.map(u => `<option value="${u.user_id}">${u.user_id} | ${u.user_name}</option>`).join('');
        
        document.getElementById('borrowEquip').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á --</option>' + 
            state.equipment.map(e => e.available_quantity > 0 
                ? `<option value="${e.equipment_code}">${e.equipment_code} - ${e.equipment_name} (‡∏ß‡πà‡∏≤‡∏á ${e.available_quantity})</option>` 
                : ''
            ).join('');
    }

    function showToast(msg, color = "bg-green-600") {
        const t = document.createElement('div');
        t.className = `toast ${color} text-white font-bold`;
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(() => {
            t.style.opacity = '0';
            setTimeout(() => t.remove(), 500);
        }, 2500);
    }

    function setDefaultDates() {
        const today = new Date().toISOString().split('T')[0];
        const borrowDateInput = document.getElementById('borrowDate');
        if(borrowDateInput) borrowDateInput.value = today;
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
