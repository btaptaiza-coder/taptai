<!doctype html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏• (Pro)</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; }
    .tab-active { background: rgba(255,255,255,0.2); border-left: 4px solid white; }
    .status-available { background: #dcfce7; color: #166534; }
    .status-borrowed { background: #fef3c7; color: #92400e; }
    .status-overdue { background: #fecaca; color: #991b1b; }
    .sidebar-gradient { background: linear-gradient(180deg, #1e3a8a 0%, #2563eb 100%); }
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 16px 24px; border-radius: 12px; color: white; z-index: 1000; transition: all 0.3s ease; }
  </style>
</head>
<body class="h-full bg-slate-50">
  <div id="app" class="h-full flex overflow-hidden">
    
    <aside class="sidebar-gradient w-64 flex-shrink-0 flex flex-col text-white shadow-xl">
      <div class="p-6 border-b border-white/10 text-center">
        <div class="text-4xl mb-2">üì¶</div>
        <h1 class="text-lg font-bold">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h1>
        <p class="text-xs text-blue-100 opacity-80">Connected to Supabase</p>
      </div>
      <nav class="flex-1 p-4 space-y-2 mt-4">
        <button onclick="switchTab('dashboard')" id="tab-dashboard" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-white/10 transition"> üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î </button>
        <button onclick="switchTab('transactions')" id="tab-transactions" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-white/10 transition"> üìã ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô </button>
        <div class="pt-4 pb-2 px-4 text-xs font-bold uppercase text-blue-200">Admin Section</div>
        <button onclick="switchTab('equipment')" id="tab-equipment" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-white/10 transition"> üîß ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå </button>
        <button onclick="switchTab('users')" id="tab-users" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-white/10 transition"> üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ </button>
        <button onclick="switchTab('reports')" id="tab-reports" class="w-full text-left px-4 py-3 rounded-lg flex items-center gap-3 hover:bg-white/10 transition"> üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ </button>
      </nav>
    </aside>

    <main class="flex-1 overflow-auto bg-gray-50">
      
      <div id="content-dashboard" class="p-8 space-y-8">
        <header>
            <h2 class="text-3xl font-bold text-gray-800">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö üëã</h2>
        </header>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <p class="text-sm text-gray-400">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            <p id="stat-total" class="text-3xl font-bold text-blue-600">-</p>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <p class="text-sm text-gray-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</p>
            <p id="stat-borrowed" class="text-3xl font-bold text-orange-500">-</p>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <p class="text-sm text-gray-400">‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á</p>
            <p id="stat-overdue" class="text-3xl font-bold text-red-500">-</p>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6 border-b border-gray-50 font-bold text-gray-700">‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î</div>
            <div id="overdue-list" class="p-0"></div>
        </div>
      </div>

      <div id="content-transactions" class="p-8 hidden">
        <h2 class="text-2xl font-bold mb-6">üìã ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="bg-white p-6 rounded-2xl shadow-sm border">
                <h3 class="font-bold mb-4 flex items-center gap-2">‚ûï ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</h3>
                <form id="borrowForm" class="space-y-4">
                    <select id="borrowUser" required class="w-full p-3 bg-gray-50 border rounded-xl"></select>
                    <select id="borrowEquip" required class="w-full p-3 bg-gray-50 border rounded-xl"></select>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-400">‡∏ß‡∏±‡∏ô‡∏¢‡∏∑‡∏°</label>
                            <input type="date" id="borrowDate" required class="w-full p-2 border rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô</label>
                            <input type="date" id="dueDate" required class="w-full p-2 border rounded-lg text-sm">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700 transition font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°</button>
                </form>
            </div>
            <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border overflow-hidden">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 text-gray-600">
                        <tr>
                            <th class="p-4 text-left">‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</th>
                            <th class="p-4 text-left">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                            <th class="p-4 text-center">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏∑‡∏ô</th>
                            <th class="p-4 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="p-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="transactionList" class="divide-y"></tbody>
                </table>
            </div>
        </div>
      </div>

      <div id="content-equipment" class="p-8 hidden">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">üîß ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="bg-white p-6 rounded-2xl border">
                <h3 class="font-bold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà</h3>
                <form id="equipmentForm" class="space-y-4">
                    <input type="text" id="equipCode" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" required class="w-full p-3 border rounded-xl">
                    <input type="text" id="equipName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" required class="w-full p-3 border rounded-xl">
                    <input type="number" id="equipQty" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" min="1" required class="w-full p-3 border rounded-xl">
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏Ñ‡∏•‡∏±‡∏á</button>
                </form>
            </div>
            <div class="lg:col-span-2 bg-white rounded-2xl border overflow-hidden">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-4 text-left">‡∏£‡∏´‡∏±‡∏™</th>
                            <th class="p-4 text-left">‡∏ä‡∏∑‡πà‡∏≠</th>
                            <th class="p-4 text-center">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
                            <th class="p-4 text-center">‡∏ß‡πà‡∏≤‡∏á</th>
                            <th class="p-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="equipmentList" class="divide-y"></tbody>
                </table>
            </div>
        </div>
      </div>

      <div id="content-users" class="p-8 hidden">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="bg-white p-6 rounded-2xl border">
                <form id="userForm" class="space-y-4">
                    <input type="text" id="userId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß (Key)" required class="w-full p-3 border rounded-xl">
                    <input type="text" id="userName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" required class="w-full p-3 border rounded-xl">
                    <input type="text" id="userDept" placeholder="‡πÅ‡∏ú‡∏ô‡∏Å" required class="w-full p-3 border rounded-xl">
                    <input type="tel" id="userPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" required class="w-full p-3 border rounded-xl">
                    <select id="userRole" class="w-full p-3 border rounded-xl">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                    </select>
                    <button type="submit" class="w-full bg-blue-800 text-white py-3 rounded-xl font-bold">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
                </form>
            </div>
            <div class="lg:col-span-2 bg-white rounded-2xl border overflow-hidden">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-4 text-left">ID</th>
                            <th class="p-4 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡πÅ‡∏ú‡∏ô‡∏Å</th>
                            <th class="p-4 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="userList" class="divide-y"></tbody>
                </table>
            </div>
        </div>
      </div>

      <div id="content-reports" class="p-8 hidden">
          <h2 class="text-2xl font-bold mb-6">üìà ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å View</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div class="bg-white p-6 rounded-2xl border">
                  <h3 class="font-bold mb-4">üèÜ ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏° (popular_equipment)</h3>
                  <div id="report-popular" class="space-y-2"></div>
              </div>
          </div>
      </div>
    </main>
  </div>

  <script>
    // --- Configuration ---
    const SUPABASE_URL = 'https://emfthjerfcvfmwancjbx.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_d1bqb5SJuK1pc-JgiaMD6Q_EZBWJCgt';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let state = {
        equipment: [],
        users: [],
        transactions: [],
        summary: {}
    };

    // --- Initialization ---
    async function initApp() {
        await Promise.all([
            fetchEquipment(),
            fetchUsers(),
            fetchTransactions(),
            fetchSummary()
        ]);
        updateDropdowns();
        renderAll();
        setDefaultDates();
    }

    // --- Data Fetching (‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏¢‡∏Å) ---
    async function fetchEquipment() {
        // ‡πÉ‡∏ä‡πâ RPC ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å function get_equipment_availability ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
        const { data, error } = await supabase.rpc('get_equipment_availability');
        if (!error) state.equipment = data;
    }

    async function fetchUsers() {
        const { data, error } = await supabase.from('users').select('*');
        if (!error) state.users = data;
    }

    async function fetchTransactions() {
        const { data, error } = await supabase.from('transactions')
            .select('*')
            .order('created_at', { ascending: false });
        if (!error) state.transactions = data;
    }

    async function fetchSummary() {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Dashboard View
        const { data, error } = await supabase.from('dashboard_summary').select('*').single();
        if (!error) {
            state.summary = data;
            document.getElementById('stat-total').textContent = data.total_equipment;
            document.getElementById('stat-borrowed').textContent = data.total_borrowed;
            document.getElementById('stat-overdue').textContent = data.total_overdue;
        }
    }

    // --- Rendering ---
    function renderAll() {
        // Equipment List
        document.getElementById('equipmentList').innerHTML = state.equipment.map(e => `
            <tr>
                <td class="p-4 font-mono font-bold">${e.equipment_code}</td>
                <td class="p-4">${e.equipment_name}</td>
                <td class="p-4 text-center">${e.total_quantity}</td>
                <td class="p-4 text-center font-bold ${e.available_quantity > 0 ? 'text-green-600' : 'text-red-500'}">${e.available_quantity}</td>
                <td class="p-4 text-center"><button onclick="deleteItem('equipment', '${e.equipment_code}')" class="text-red-400">üóëÔ∏è</button></td>
            </tr>
        `).join('');

        // Transaction List
        document.getElementById('transactionList').innerHTML = state.transactions.map(t => {
            const isOverdue = new Date(t.transaction_due_date) < new Date() && t.transaction_status === 'borrowed';
            return `
                <tr>
                    <td class="p-4">${t.transaction_user_id}</td>
                    <td class="p-4 font-mono text-xs">${t.transaction_equipment_code}</td>
                    <td class="p-4 text-center">${t.transaction_due_date}</td>
                    <td class="p-4 text-center">
                        <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase ${t.transaction_status === 'returned' ? 'status-available' : (isOverdue ? 'status-overdue' : 'status-borrowed')}">
                            ${t.transaction_status === 'returned' ? '‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : (isOverdue ? '‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°')}
                        </span>
                    </td>
                    <td class="p-4 text-center">
                        ${t.transaction_status === 'borrowed' ? `<button onclick="returnItem('${t.id}')" class="bg-green-100 text-green-700 px-3 py-1 rounded-lg text-xs font-bold">‡∏Ñ‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á</button>` : '-'}
                    </td>
                </tr>
            `;
        }).join('');

        // User List
        document.getElementById('userList').innerHTML = state.users.map(u => `
            <tr>
                <td class="p-4 font-bold text-blue-800">${u.user_id}</td>
                <td class="p-4">${u.user_name}<br><small class="text-gray-400">${u.user_department}</small></td>
                <td class="p-4 text-center"><button onclick="deleteItem('users', '${u.user_id}')" class="text-red-400">üóëÔ∏è</button></td>
            </tr>
        `).join('');

        // Popular Report
        renderPopular();
    }

    async function renderPopular() {
        const { data } = await supabase.from('popular_equipment').select('*').limit(5);
        if (data) {
            document.getElementById('report-popular').innerHTML = data.map(item => `
                <div class="flex justify-between p-2 bg-gray-50 rounded">
                    <span>${item.transaction_equipment_code}</span>
                    <span class="font-bold text-blue-600">${item.borrow_count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                </div>
            `).join('');
        }
    }

    // --- Actions ---
    document.getElementById('borrowForm').onsubmit = async (e) => {
        e.preventDefault();
        const payload = {
            transaction_user_id: document.getElementById('borrowUser').value,
            transaction_equipment_code: document.getElementById('borrowEquip').value,
            transaction_borrow_date: document.getElementById('borrowDate').value,
            transaction_due_date: document.getElementById('dueDate').value,
            transaction_status: 'borrowed'
        };
        const { error } = await supabase.from('transactions').insert([payload]);
        if (error) {
            alert("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message); // ‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤ 'Equipment not available' ‡∏à‡∏≤‡∏Å Trigger
        } else {
            showToast("‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            e.target.reset();
            initApp();
        }
    };

    document.getElementById('equipmentForm').onsubmit = async (e) => {
        e.preventDefault();
        const payload = {
            equipment_code: document.getElementById('equipCode').value,
            equipment_name: document.getElementById('equipName').value,
            equipment_quantity: parseInt(document.getElementById('equipQty').value)
        };
        const { error } = await supabase.from('equipment').insert([payload]);
        if (!error) { showToast("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß"); e.target.reset(); initApp(); }
    };

    document.getElementById('userForm').onsubmit = async (e) => {
        e.preventDefault();
        const payload = {
            user_id: document.getElementById('userId').value,
            user_name: document.getElementById('userName').value,
            user_department: document.getElementById('userDept').value,
            user_phone: document.getElementById('userPhone').value,
            user_role: document.getElementById('userRole').value
        };
        const { error } = await supabase.from('users').insert([payload]);
        if (!error) { showToast("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß"); e.target.reset(); initApp(); }
    };

    async function returnItem(id) {
        const { error } = await supabase.from('transactions')
            .update({ transaction_status: 'returned', transaction_return_date: new Date().toISOString() })
            .eq('id', id);
        if (!error) { showToast("‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "bg-blue-600"); initApp(); }
    }

    async function deleteItem(table, code) {
        if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
        let column = table === 'users' ? 'user_id' : 'equipment_code';
        const { error } = await supabase.from(table).delete().eq(column, code);
        if (error) alert("‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô");
        else { showToast("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß", "bg-gray-800"); initApp(); }
    }

    // --- UI Helpers ---
    function switchTab(tabId) {
        document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
        document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('tab-active'));
        document.getElementById(`content-${tabId}`).classList.remove('hidden');
        document.getElementById(`tab-${tabId}`).classList.add('tab-active');
    }

    function updateDropdowns() {
        document.getElementById('borrowUser').innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°</option>' + 
            state.users.map(u => `<option value="${u.user_id}">${u.user_id} - ${u.user_name}</option>`).join('');
        
        document.getElementById('borrowEquip').innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</option>' + 
            state.equipment.map(e => e.available_quantity > 0 ? `<option value="${e.equipment_code}">${e.equipment_code} | ${e.equipment_name} (‡∏ß‡πà‡∏≤‡∏á ${e.available_quantity})</option>` : '').join('');
    }

    function showToast(msg, color = "bg-green-600") {
        const t = document.createElement('div');
        t.className = `toast ${color} shadow-lg`;
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    function setDefaultDates() {
        const today = new Date().toISOString().split('T')[0];
        if(document.getElementById('borrowDate')) document.getElementById('borrowDate').value = today;
    }

    initApp();
  </script>
</body>
</html>
